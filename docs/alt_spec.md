# Что такое SPEC-файл?

Spec-файл можно рассматривать как "инструкцию", которую утилита ``rpmbuild`` использует для фактической сборки RPM-пакет. Он сообщает системе сборки, что делать, определяя инструкции в серии разделов. Разделы определены в __Преамбуле__ и в __Основной части__. __Преамбула__ содержит ряд элементов метаданных, которые используются в __Основной части__. Тело содержит основную часть инструкций.

## Пример .spec-файла

Данный пример взять из [ALT Linux Wiki](https://www.altlinux.org/SampleSpecs/program).

```
Name: sampleprog
Version: 1.0
Release: alt1

Summary: Sample program specfile
Summary(ru_RU.UTF-8): Пример спек-файла для программы

License: GPLv2+
Group: Development/Other
Url: http://www.altlinux.org/SampleSpecs/program

Packager: Sample Packager <sample@altlinux.org>

Source: %name-%version.tar
Patch0: %name-1.0-alt-makefile-fixes.patch

%description
This specfile is provided as sample specfile for packages with programs.
It contains most of usual tags and constructions used in such specfiles.

%description -l ru_RU.UTF-8
Этот спек-файл является примером спек-файла для пакета с программой. Он содержит
основные теги и конструкции, используемые в подобных спек-файлах.

%prep
%setup
%patch0 -p1

%build
%configure
%make_build

%install
%makeinstall_std
%find_lang %name

%files -f %name.lang
%doc AUTHORS ChangeLog NEWS README THANKS TODO contrib/ manual/
%_bindir/*
%_man1dir/*

%changelog
* Sat Sep 33 3001 Sample Packager <sample@altlinux.org> 1.0-alt1
- initial build

```

## Пункты преамбулы

В этой таблице перечислены элементы, используемые в разделе преамбулы файла спецификации RPM:


| SPEC Директива    | Определение                                                       |
|:----------------- |:----------------------------------------------------------------- |
| ``Name``          | Базовое имя пакета, которое должно совпадать с именем spec-файла. |
| ``Version``       | Версия upstream-кода.                                             |
| ``Release``       | Релиз пакета используется для указания номера сборки пакета при данной версии upstream-кода. Как правило, установите начальное `alt1`  и увеличивайте его с каждым новым выпуском пакета, например: alt1, alt2, alt3 и т.д. Сбросьте значение до alt1 при создании новой версии программного обеспечения. |
| ``Summary``       | Краткое, в одну строку, описание пакета. |
| ``License``       | Лицензия на собираемое программное обеспечение. |
| ``Group``         | Используется для указания категории, к которой относится пакет. Указанная группа должна находиться в списке групп, известном RPM. Этот список располагается в файле /usr/lib/rpm/GROUPS, идущим вместе с пакетом rpm. |
| ``URL``           | Полный URL-адрес для получения дополнительной информации о программе. Чаще всего это ссылка на **GitHub** upstream-проекта для собираемого программного обеспечения. |
| ``Source0``       | Путь или URL-адрес к сжатому архиву исходного кода (не исправленный, исправления обрабатываются в другом месте). Этот раздел должен указывать на доступное и надежное хранилище архива, например, на upstream-страницу, а не на локальное хранилище сборщика. При необходимости можно добавить дополнительные исходные директивы, каждый раз увеличивая их количество, например: Source1, Source2, Source3 и так далее. |
| ``Patch0``        | Название первого патча, который при необходимости будет применен к исходному коду. При необходимости можно добавить дополнительные директивы PatchX, увеличивая их количество каждый раз, например: Patch1, Patch2, Patch3 и так далее. |
| ``BuildArch``     | Если пакет не зависит от архитектуры, например, если он полностью написан на интерпретируемом языке программирования, установите для этого значение ``BuildArch: noarch``. Если этот параметр не задан, пакет автоматически наследует архитектуру компьютера, на котором он собран, например ``x86_64``. |
| ``BuildRequires`` | Разделённый запятыми или пробелами список пакетов, необходимых для сборки программы. Может быть несколько записей ``BuildRequires``, каждая в отдельной строке в SPEC файле. |
| ``Requires`` | Разделённый запятыми или пробелами список пакетов, необходимых программному обеспечению для запуска после установки. Это его **зависимости** Может быть несколько записей ``Requires``, каждая в отдельной строке в SPEC файле. |
| ``ExcludeArch``   | Если часть программного обеспечения не может работать на определенной архитектуре процессора, Вы можете исключить эту архитектуру здесь. |

Директивы ``Name``, ``Version`` и ``Release`` содержат имя RPM-пакета. Эти три директивы часто называют ***N-V-R*** или ***NVR***, поскольку имена RPM-пакета имеют формат ``NAME-VERSION-RELEASE``.

Вы можете получить пример ``NAME-VERSION-RELEASE``, выполнив запрос с использованием ``rpm`` для конкретного пакета:

```bash
$ rpm -q rpmdevtools 
rpmdevtools-8.10-alt2.noarch

```

Здесь ``rpmdevtools`` - это имя пакета, ``8.10`` - версия, а ``alt2`` - релиз. Последний маркер ``noarch`` - сведения об архитектуре.
В отличие от NVR, маркер архитектуры не находится под прямым управлением сборщика, а определяется средой сборки ``rpmbuild``. Исключением из этого правила является архитектурно-независимый пакет ``noarch``.

| SPEC Директива   | Определение  |
| ---------------- | -------------|
| ``%description`` | Полное описание программного обеспечения, входящего в комплект поставки RPM. Это описание может занимать несколько строк и может быть разбито на абзацы. |
| ``%prep``        | Команда или серия команд для подготовки программного обеспечения к сборке, например, распаковка архива из Source0. Эта директива может содержать сценарий оболочки (shell скрипт). |
| ``%build``   | Команда или серия команд для фактической сборки программного обеспечения в машинный код (для скомпилированных языков) или байт-код (для некоторых интерпретируемых языков). |
| ``%install``     | Раздел, который во время сборки пакета эмулирует конечные пути установки файлов в систему. Команда или серия команд для копирования требуемых артефактов сборки из ``%builddir`` (где происходит сборка) в``%buildroot`` каталог (который содержит структуру каталогов с файлами, подлежащими сборке). Обычно это означает копирование файлов из ``~/rpmbuild/BUILD`` в ``~/rpmbuild/BUILDROOT`` и создание необходимых каталогов ``~/rpmbuild/BUILDROOT``.  Это выполняется только при создании пакета, а не при установке пакета конечным пользователем. Подробности см. в разделе [Работа со SPEC файлом](#working-with-spec-files).|
| ``%check``       | Команда или серия команд для тестирования программного обеспечения. Обычно включает в себя такие вещи, как модульные тесты.|
| ``%files``       | Список файлов, которые будут установлены в системе конечного пользователя.|
| ``%changelog``   | Запись изменений, произошедших с пакетом между различными ``Version`` или ``Release`` сборками.|

**📌 NOTE**\
Конструкция `%setup` в Sisyphus RPM использует флаг `-q` (quiet) по умолчанию. Запись %setup -q и %setup - полностью идентичны. Если использовать конструкцию с флагом `-v`, то будет выведена дополнительная информация в логах сборки. 

## Составляющие основной части

В этой таблице перечислены элементы, используемые в теле файла спецификации RPM-пакета:


| SPEC Директива   | Определение      |
|:---------------- |:---------------- |
| ``%description`` | Полное описание программного обеспечения, входящего в комплект поставки RPM. Это описание может занимать несколько строк и может быть разбито на абзацы. |
| ``%prep``        | Команда или серия команд для подготовки программного обеспечения к сборке, например, распаковка архива из Source0. Эта директива может содержать сценарий оболочки (shell скрипт). |
| ``%build``       | Команда или серия команд для фактической сборки программного обеспечения в машинный код (для скомпилированных языков) или байт-код (для некоторых интерпретируемых языков). |
| ``%install``     | Раздел, который во время сборки пакета эмулирует конечные пути установки файлов в систему. Команда или серия команд для копирования требуемых артефактов сборки из ``%builddir`` (где происходит сборка) в``%buildroot`` каталог (который содержит структуру каталогов с файлами, подлежащими сборке). Обычно это означает копирование файлов из ``~/rpmbuild/BUILD`` в ``~/rpmbuild/BUILDROOT`` и создание необходимых каталогов ``~/rpmbuild/BUILDROOT``.  Это выполняется только при создании пакета, а не при установке пакета конечным пользователем. Подробности см. в разделе [Работа со SPEC файлом](#working-with-spec-files). |
| ``%check``       | Команда или серия команд для тестирования программного обеспечения. Обычно включает в себя такие вещи, как модульные тесты. |
| ``%files``       | Список файлов, которые будут установлены в системе конечного пользователя. |
| ``%changelog``   | Запись изменений, произошедших с пакетом между различными ``Version`` или ``Release`` сборками. |

**📌 NOTE**\
Конструкция `%setup`  RPM использует флаг `-q` (quiet) по умолчанию. Запись %setup -q и %setup - полностью идентичны. Если использовать конструкцию с флагом `-v`, то будет выведена дополнительная информация в логах сборки  

"Каркас" файла спецификации с кратким описанием составляющих:

```
Name: mypackage
Version: 1.0
Release: 1
Summary: Однострочное описание пакета. 

%description
Общее описание пакета. Примерно 1 абзац. 

%prep
# Подготовка исходных файлов для сборки

%build
# Компиляция и сборка пакета

%install
# Установка файлов в директорию сборки
install -D -m 0644 %{SOURCE1} %{buildroot}/путь/к/файлу/example.txt

%files
# Перечисление файлов и директорий, которые будут включены в пакет
%{buildroot}/путь/к/файлу/example.txt
```

Пример выше - достаточно простой. `Spec-файл` может быть куда больше, включать больше секций и команд. В некоторых случаях один `spec-файл` используется для сборки множества пакетов.
